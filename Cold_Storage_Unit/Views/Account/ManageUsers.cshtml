@model Tuple<Cold_Storage_Unit.Models.LoginViewModel, List<Cold_Storage_Unit.Models.LoginViewModel>, List<Cold_Storage_Unit.Models.UserLogActivityViewModel>>
@{
    ViewBag.Title = "Banana Cold Storage";
    var userModel = Model.Item1;
    var userList = Model.Item2;
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
    .custom-shadow {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        border: 2px solid #dee2e6;
    }
</style>


<h2>Manage Users</h2>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}

<button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#userModal" onclick="openAddForm()">Add User</button>

<div class="table-responsive shadow p-3 rounded h-auto container">
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Username</th>
                <th>Name</th>
                <th>Surname</th>
                <th>Email</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var user in userList)
            {
                <tr>
                    <td>@user.Username</td>
                    <td>@user.Name</td>
                    <td>@user.Surname</td>
                    <td>@user.Email</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="openEditForm('@user.Username')">Edit</button>
                        <a href="@Url.Action("Delete", "Account", new { username = user.Username })" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure to delete?');">Delete</a>
                        <button class="btn btn-info btn-sm" onclick="filterUserLogs('@user.Username')">Log</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<div id="loginActivitySection" class="table-responsive shadow p-3 rounded h-auto container mt-4" style="display: none;">
    <h3>User Login Activity</h3>
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Username</th>
                <th>Login Count</th>
                <th>Last Login Date</th>
                <th>Session Duration</th>
                <th>IP Address</th>
                <th>Location</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var log in Model.Item3)
            {
                <tr data-username="@log.UserName">
                    <td>@log.UserName</td>
                    <td>@log.LoginFrequency</td>
                    <td>@log.ActivityDate</td>
                    <td>@log.TimeSpent</td>
                    <td>@log.IPAddress</td>
                    <td>@log.Location</td>
                </tr>
            }
        </tbody>
    </table>
</div>


<!-- Modal -->
<div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalLabel">User Form</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="userFormContainer">
                    <!-- Form will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
    function openAddForm() {
        $.get('@Url.Action("Register", "Account")', function (data) {
            $('#userFormContainer').html(data);
            $('#userModalLabel').text("Add New User");
        });
    }

    function openEditForm(username) {
        $.get('@Url.Action("Edit", "Account")', { username: username }, function (data) {
            $('#userFormContainer').html(data);
            $('#userModalLabel').text("Edit User");
            $('#userModal').modal('show');
        });
    }
    </script>

    <script>
        function filterUserLogs(username) {
            // Show the login activity section
            document.getElementById('loginActivitySection').style.display = 'block';

            // Filter table rows by username
            const allRows = document.querySelectorAll('[data-username]');
            allRows.forEach(row => {
                if (row.getAttribute('data-username') === username) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function showAllLogs() {
            document.getElementById('loginActivitySection').style.display = 'block';
            const allRows = document.querySelectorAll('[data-username]');
            allRows.forEach(row => {
                row.style.display = '';
            });
        }
    </script>

}
